<link type="text/css" rel="stylesheet" href="/Sodexo/innfinite2-worthydown/assets/css/reservation.css" />

<div class="overlay-bg"></div>

<div class="custom-section-wrap" >
  <div class="alert alert-primary custom-logo-top no-icon m-0 alert-dismissible fade show" role="alert">
    Business Profile
  </div>
  <div class="custom-section" [ngClass]="{'table-loader': state.processing}">
    <ng-container>
      <div class="custom-main template-outer">
        <ng-container>
          <div class="custom-content tabs-content" id="content-1" style="display: block;">
            <div class="book-time-wrap">
              <div class="row">
                <ng-container *ngFor="let field of formFields; let i = index">

                  <div class="col-md-6 col-12" [ngStyle]="{display: field.visible ? '' : 'none'}">

                      <app-form-fields
                        [field]="field"
                        [definitionType]="1"
                        [form]="form"
                        [resourceType]="'00000000-0000-0000-0000-000000000000'"
                        [index]="-1"
                        [fieldIndex]="i"
                        [bookingID]="state.bookingID"
                        (fieldBinding)="bindField($event)"
                        [hasIcon]="state.processing"
                      >

                      </app-form-fields>
                  </div>
                </ng-container>
              </div>
              <div class="reservation-bot-btns d-flex">
                <a href="javascript:void(0);" class="btn btn-danger" (click)="openModal()">
                  Cancel
                </a>
                <button type="submit" class="btn btn-success ml-auto" (click)="submitForm()" [disabled]="state.processing" >Next <span class="fa fa-angle-right"></span> <span class="fa fa-spin fa-spinner" *ngIf="state.processing"></span></button>
              </div>
            </div>
          </div>
          <!-- data-toggle="modal" data-target="#exampleModal"-->
        </ng-container>
        <!--<br/>
        <button type="submit" class="btn btn-info btn-block" (click)="submitForm()" [disabled]="state.processing">Next <span class="fa fa-spin fa-spinner" *ngIf="state.processing"></span></button>-->

      </div>
      <app-confirm-modal [confirmationMessage]="'Do you want to restart reservation?'" (isConfirmed)="restartReservation($event)"></app-confirm-modal>
    </ng-container>
  </div>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModal" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">New Booking</h5><button aria-label="Close" class="close" data-dismiss="modal" type="button"><span aria-hidden="true">Ã—</span></button>
      </div>
      <div class="modal-body p-0">
        <div class="modal-topbar form-primary form-grey">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3 field-wrap-outer">
                <label>Add Traveler</label>
                <div class="field-wrap field-gray-wrap traveler-field m-0">
                  <span class="user top-22 field-icon mt-secon"></span>
                  <ng-autocomplete
                    [data]="travelerList"
                    [searchKeyword]="keyword"
                    (selected)='selectTraveler($event)'
                    (inputChanged)='getloadProfiles($event)'
                    (inputFocused)='onFocused($event)'
                    [itemTemplate]="itemTemplateProfiles"
                    (inputCleared)="searchCleared('traveler-list')"
                    [notFoundTemplate]="notFoundProfilesTemplate"
                    [debounceTime]="400"
                    [isLoading]="state.isLoadingTraveler"
                    [minQueryLength]="3"
                    placeHolder="{{'Search Traveler'}}"
                    class="flex-automate"
                    name="traveler"
                    autocomplete="off"
                  >

                  </ng-autocomplete>

                  <ng-template #itemTemplateProfiles let-item>
                    <a href="javascript:void(0)">
                      <div class="auto-txtwrap text-left">
                        <div class="autotxt" [innerHTML]="item.lastName+'-'+item.firstName">
                        </div>
                      </div>
                    </a>
                  </ng-template>

                  <ng-template #notFoundProfilesTemplate let-notFound>
                    {{state.errorMsg}}
                  </ng-template>
                  <div class="" *ngIf="state.error">
                    <label class="error">{{state.error['message']}}</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label>Add / Replace</label>
                <div class="input-group mb-4">
                  <select class="form-control" [(ngModel)]="form.resourceTypeID">
                    <option value="00000000-0000-0000-0000-000000000000">Select Resources</option>
                    <option value="{{resource.value}}" *ngFor="let resource of state.addableResourceTypes">{{resource.text}}</option>
                  </select>
                  <div class="input-group-append">
                    <button class="btn btn-success" (click)="loadCriteriaDefinitions()"> <span class="fa fa-plus"></span> Add</button>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
        <ng-container *ngIf="resources.length > 0" >
          <div class="accordion accordion-sm custom-accordion text-left" id="accordionExample">
            <div class="mb-3" id="accordion_{{i}}" *ngFor="let resource of resources; let i = index">
              <div class="card-header" id="heading_{{i}}">
                <h2 class="accordion-link has-delete-icon" aria-expanded="false"
                    [attr.data-toggle]="resources.length > 1 ? 'collapse': ''"
                    [attr.data-target]="resources.length > 1 ? '#collaps-'+i : ''"
                    [attr.aria-expanded]="'true'"
                    >
                  <span>{{resource.name}} - {{resource['resources'][0]['resourceItems'][0].text}}</span>
                  <a href="javascript:void(0)" (click)="removeResource(i)" class="fa fa-trash-o remove-accordion"></a>
                </h2>
              </div>
              <div id="collaps-{{i}}" class="collapse" [ngClass]="{'show': (resource['resources'][0]['isOpen'] || resources.length == 1), 'table-loader': resource['resources'][0].processing}" >
                <div class="box box-lr">
                  <div class="row">
                    <ng-container>
                      <div class="col-md-6">
                        <div class="field-wrap-outer">
                          <label>{{resource['resources'][0]['beginWord'] || 'Departure'}} Date<span class="" [ngClass]="{'text-danger': !resource['resources'][0]['BeginDate']}">*</span></label>

                          <div class="field-wrap" [ngClass]="{'is-invalid-wrap' : resource['resources'][0]['errors']['BeginDate']&&resource['resources'][0]['errors']['BeginDate'] != '' }">
                            <input type="text"
                                   [(ngModel)]="resource['resources'][0]['BeginDate']"
                                   bsDatepicker
                                   [bsConfig]="bsConfig"
                                   (ngModelChange)="setDateTo(i); resetErrorState(i, 'BeginDate')"
                                   [minDate]="minDateFrom"
                                   [maxDate]="maxDateFrom"
                                   placeholder="{{resource['resources'][0]['beginWord'] || 'Departure'}} Date"
                                   name="departure_date"
                                   autocomplete="off"
                                   class="form-control">
                            <span class="fa fa-calendar-o"></span>
                            <label class="error text-danger" *ngIf="resource['resources'][0]['errors']['BeginDate']">{{resource['resources'][0]['errors']['BeginDate']}}</label>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6" *ngIf="resource['resources'][0].canSearchByTime">
                        <div class="row">
                          <div class="col-md-12 col-12">
                            <div class="field-wrap-outer">
                              <label>{{resource['resources'][0]['beginWord'] || 'Departure'}} Time</label>
                              <div class="field-wrap time-picker-wrap field-wrap-outer field-gray-wrap"
                                   [ngClass]="{
                                    'is-invalid-wrap' : false,
                                    'is-valid-wrap' : false
                                 }" id="BeginTime_container_{{i+1}}">
                                <ng-autocomplete
                                  [data]="userService.getSettingByProp('timeFormat') == 24 ? TPService.timeSlots24Format: TPService.timeSlots12Format"
                                  [searchKeyword]="timePickerkeyword"
                                  (inputFocused)='onFocused($event)'
                                  (selected)='selectTime($event, i, "BeginTime")'
                                  [itemTemplate]="beginTime_"
                                  [debounceTime]="400"
                                  [isLoading]="state.beginTimeProcessing"
                                  [minQueryLength]="1"
                                  placeHolder="{{resource['resources'][0]['beginWord'] || 'Departure'}} Time"
                                  name="search"
                                >
                                </ng-autocomplete>

                                <ng-template #beginTime_ let-item>
                                  <a href="javascript:void(0)">
                                    <div class="auto-txtwrap">
                                      <div class="autotxt">
                                        <span [innerHTML]="item.text"></span>
                                      </div>
                                    </div>
                                  </a>
                                </ng-template>
                                <label class="error text-danger" *ngIf="resource['resources'][0]['errors']['BeginTime']">{{resource['resources'][0]['errors']['BeginTime']}}</label>
                              </div>
                            </div>
                          </div>

                        </div>

                      </div>

                      <div class="col-md-6" *ngIf="resource['resources'][0].requiresEndDate">
                        <div class="field-wrap-outer">
                          <label>{{resource['resources'][0]['endWord'] || 'Return'}} Date<span class="" [ngClass]="{'text-danger': !resource['resources'][0]['EndDate']}">*</span></label>

                          <div class="field-wrap" [ngClass]="{'is-invalid-wrap' :  resource['resources'][0]['errors']['EndDate'] && resource['resources'][0]['errors']['EndDate'] != '' }">
                            <input type="text"
                                   [(ngModel)]="resource['resources'][0]['EndDate']"
                                   bsDatepicker
                                   [minDate]="minDateFrom"
                                   [maxDate]="maxDateFrom"
                                   [bsConfig]="bsConfig"
                                   (ngModelChange)="setDateFrom(i); resetErrorState(i, 'EndDate')"
                                   placeholder="{{resource['resources'][0]['endWord'] || 'Return'}} Date"
                                   autocomplete="off"
                                   name="arrival_date"
                                   class="form-control">
                            <span class="fa fa-calendar-o"></span>
                            <label class="error text-danger" *ngIf="resource['resources'][0]['errors']['EndDate']">{{resource['resources'][0]['errors']['EndDate']}}</label>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6" *ngIf="resource['resources'][0].requiresEndDate && resource['resources'][0].canSearchByTime">
                        <div class="row">
                          <div class="col-md-12 col-12">
                            <div class="field-wrap-outer time-picker-wrap">
                              <label>{{resource['resources'][0]['endWord'] || 'Return'}} Time</label>
                              <div class="field-wrap time-picker-wrap field-wrap-outer field-gray-wrap"
                                   [ngClass]="{
                                    'is-invalid-wrap' : false,
                                    'is-valid-wrap' : false
                                 }" id="ReturnTime_container_{{i+1}}">
                                <ng-autocomplete
                                  [data]="userService.getSettingByProp('timeFormat') == 24 ? TPService.timeSlots24Format : TPService.timeSlots12Format"
                                  [searchKeyword]="timePickerkeyword"
                                  (inputFocused)='onFocused($event)'
                                  (selected)='selectTime($event, i, "ReturnTime")'
                                  [itemTemplate]="endTime_"
                                  [debounceTime]="400"
                                  [isLoading]="state.beginTimeProcessing"
                                  [minQueryLength]="1"
                                  placeHolder="{{resource['resources'][0]['endWord'] || 'Return'}} Time"
                                  name="search"
                                >
                                </ng-autocomplete>

                                <ng-template #endTime_ let-item>
                                  <a href="javascript:void(0)">
                                    <div class="auto-txtwrap">
                                      <div class="autotxt">
                                        <span [innerHTML]="item.text"></span>
                                      </div>
                                    </div>
                                  </a>
                                </ng-template>
                                <label class="error text-danger" *ngIf="resource['resources'][0]['errors']['BeginTime']">{{resource['resources'][0]['errors']['BeginTime']}}</label>
                              </div>
                            </div>
                          </div>

                        </div>

                      </div>
                    </ng-container>
                    <ng-container *ngFor="let field of resource['resources'][0]['searchFields']; let j = index">
                      <div class="col-md-6 col-12" >
                        <app-form-fields
                          [field]="field"
                          [definitionType]="1"
                          [form]="myForm"
                          [resourceType]="resource['resources'][0]['resourceTypeID']"
                          [index]="i"
                          [fieldIndex]="j"
                          [bookingID]="state.bookingID"
                          (fieldBinding)="bindBookingField($event)"
                          [hasIcon] = "resource['resources'][0].processing"
                        >
                        </app-form-fields>
                      </div>
                    </ng-container>
                    <ng-container class="col-md-6" *ngFor="let field of resource['resources'][0]['resourceItems']; let k =index">
                        <div class="col-md-12 col-12" *ngIf="field.isBlockable">
                          <label>{{field.text}}<span
                            [ngClass]="{'text-danger': field.isRequired && !field['model'].value}">{{field.isRequired ? '*' : ''}}</span></label>
                          <div class="">
                            <div class="field-wrap">
                              <span class="fa fa-spin fa-spinner" *ngIf="field.processing"></span>
                              <select class="form-control" [ngClass]="{
                                          'no-icon': !field.processing,
                                          'has-icon': field.processing,
                                          'is-invalid' : field['validationError'] && field['validationError'] != 'passed' && field.isRequired,
                                          'is-valid' : field['validationError'] && field['validationError'] == 'passed' && field.isRequired
                                          }" [(ngModel)]="field.model" [disabled]="field.processing" >
                                <option value="">Please Select {{field.text}}</option>
                                <option [ngValue]="item['values2']" *ngFor="let item of field.results">{{item['values2']['Text']}}</option>

                              </select>

                              <label class="error text-danger"
                                     *ngIf="field.validationError && field.validationError != 'passed'">{{field.validationError}}</label>
                            </div>
                          </div>
                        </div>
                      </ng-container>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" data-dismiss="modal" type="button">Close</button>
        <button class="btn btn-success" type="button" (click)="startBookingSearch()">Save</button>
      </div>
    </div>
  </div>
</div>


<div class="booking-article-bot" *ngIf="state.bookedSegments.length>0">
  <!-- <a href="javascript:void(0);" class="new-booking"><span></span></a> -->
  <a href="javascript:void(0);" *ngIf="!state.bookingContentArea" (click)="toggleBookingContentArea(true);" class="new-booking">
  </a>
  <div class="booking-content-area" *ngIf="state.bookingContentArea" style="display:block;">
    <div class="booking-top">
      <a class="close-booking" href="javascript:void(0)" (click)="toggleBookingContentArea(false);"><span class="fa fa-close"></span></a>
      <div class="booking-art-title">
        <h3>New Booking</h3>
      </div>
      <div class="booking-search">
        <input class="form-control" placeholder="Search by name" type="text">
      </div>
    </div>
    <div class="booking-art-inner">
      <ul>
        <ng-container *ngFor="let segment of state.bookedSegments;let segmentIndex=index">
          <ng-container *ngIf="segment.resourceName != 'Room'">
            <li *ngFor="let seg of segment.segments; let i=index"
                [ngClass]="{'isStopover': !seg.isStopover}"
            >
              <h4><img src="{{segment.providerLogoUrl}}" width="20"/>{{segment.resourceName}}</h4>
              <h5>
                {{seg.identifier}}
                <span>{{dateParse.formatDateForCart(seg.beginDate)}}</span>
                <span *ngIf="seg.beingDate<seg.endDate">{{dateParse.formatDateForCart(seg.endDate)}}</span>
              </h5>
              <p>{{userService.getSettingByProp('timeFormat') == '' ? dateParse.formatDateBy12HourTime(seg.beginDate) : dateParse.parseDateToTime(seg.beginDate)}} : {{seg.from}}</p>
              <p>{{userService.getSettingByProp('timeFormat') == '' ? dateParse.formatDateBy12HourTime(seg.endDate) : dateParse.parseDateToTime(seg.endDate)}} : {{seg.to}}</p>
              <div class="booking-subtotal" *ngIf="i==(segment.segments.length-1) && segment.totalPrice">
                <span>{{segment.priceName}}</span><strong>{{segment.totalPrice}}</strong>
              </div>
              <span *ngIf="!seg.isStopover">{{dateParse.calculateDifferenceInTime(seg.endDate, state.bookedSegments[segmentIndex].segments[(i+1)].beginDate)}}</span>
            </li>
          </ng-container>
          <ng-container *ngIf="segment.resourceName == 'Room'">
            <li>
              <h4><img *ngIf="segment.providerLogoUrl" src="{{segment.providerLogoUrl}}" width="20"/>{{segment.resourceName}}</h4>
              <h5>
                <span>{{dateParse.formatDateForCart(segment.beginDate)}}</span>
                <span *ngIf="segment.beingDate<segment.endDate">{{dateParse.formatDateForCart(segment.endDate)}}</span>
              </h5>
              <p *ngFor="let field of segment.searchProperties">
                {{field.fieldName}} : {{field.selection}}
              </p>
              <div class="booking-subtotal" *ngIf="segment.totalPrice">
                <span>{{segment.priceName}}</span><strong>{{segment.totalPrice}}</strong>
              </div>
            </li>
          </ng-container>
        </ng-container>
        <li>
          <button class="btn btn-primary pull-right" data-target="#exampleModal" data-toggle="modal">Add/Replace</button>
        </li>
      </ul>
    </div>
  </div>
</div>
